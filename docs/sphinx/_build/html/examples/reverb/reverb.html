<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reverberation Mapping &mdash; python 86g documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Demo: Quasar, M20" href="../demo-models/quasar/quasar.html" />
    <link rel="prev" title="Examples" href="../../examples.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            python
          </a>
              <div class="version">
                86
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../quick.html"><em>Quick Guide to Python</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running_python.html">Running Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../input.html">Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../output.html">Outputs &amp; Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plotting.html">Plotting &amp; Processing Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../operation.html">Code Operation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../radiation.html">Radiation Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wind_models.html">Wind Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../coordinate.html">Coordinate grids</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../examples.html">Examples</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Reverberation Mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="../demo-models/quasar/quasar.html">Demo: Quasar, M20</a></li>
<li class="toctree-l2"><a class="reference internal" href="../demo-models/tde/tde.html">Demo: Tidal Disruption Event</a></li>
<li class="toctree-l2"><a class="reference internal" href="../benchmarking/cmfgen.html">Benchmark: 1D Stellar Wind, CMFGEN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../benchmarking/tardis.html">Benchmark: 1D Homologous SN, Tardis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../physics.html">Physics &amp; Radiative Transfer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../atomic.html">Atomic Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../meta.html">Meta-documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer.html">Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../py_progs.html">Python Scripts</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">python</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../examples.html">Examples</a></li>
      <li class="breadcrumb-item active">Reverberation Mapping</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/examples/reverb/reverb.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Reverberation-Mapping">
<h1>Reverberation Mapping<a class="headerlink" href="#Reverberation-Mapping" title="Permalink to this heading"></a></h1>
<p><code class="docutils literal notranslate"><span class="pre">Python</span></code> has the capability to generate transfer functions/reverberation signatures for the systems it models. These describe how a change in the ionising continuum is reprocessed into a change in line emission. These signatures can (approximately) be recovered from observation, if there’s a sufficiently series of line spectra with sufficiently high time- and wavelength-resolution.</p>
<p>The transfer function is the term <span class="math notranslate nohighlight">\(\Psi\)</span> in the equation <span class="math notranslate nohighlight">\(L(v, t) = \int_0^\infty \Psi(v, \tau) C(t - \tau) d\tau\)</span>. <code class="docutils literal notranslate"><span class="pre">Python</span></code> can also generate response functions, <span class="math notranslate nohighlight">\(\Psi_r\)</span>, used in <span class="math notranslate nohighlight">\(\delta L(v, t) = \int_0^\infty \Psi_r(v, \tau) \delta C(t - \tau) d\tau\)</span> (a more observationally-accessible property).</p>
<p>The paper discussing our implementation, and the differences between <span class="math notranslate nohighlight">\(\Psi\)</span> and <span class="math notranslate nohighlight">\(\Psi_r\)</span> are:</p>
<ul class="simple">
<li><p>Mangham 2018 [<a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2017MNRAS.471.4788M/abstract">https://ui.adsabs.harvard.edu/abs/2017MNRAS.471.4788M/abstract</a>]</p></li>
<li><p>Mangham 2019 [<a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2019MNRAS.488.2780M/abstract">https://ui.adsabs.harvard.edu/abs/2019MNRAS.488.2780M/abstract</a>]</p></li>
</ul>
<section id="'Basic'-Transfer-Function">
<h2>‘Basic’ Transfer Function<a class="headerlink" href="#'Basic'-Transfer-Function" title="Permalink to this heading"></a></h2>
<p>This example uses the <code class="docutils literal notranslate"><span class="pre">examples/basic/reverb.pf</span></code> file to generate the transfer function for a biconical outflowing disk wind around an AGN, driven by continuum emission of both X-rays from a spherical corona and UV emission from the hot inner regions of the accretion disk.</p>
<section id="Building-the-Model">
<h3>Building the Model<a class="headerlink" href="#Building-the-Model" title="Permalink to this heading"></a></h3>
<p>To generate the data for reverberation mapping, <code class="docutils literal notranslate"><span class="pre">Python</span></code> tracks the paths of photons as they travel throughout the wind, using them to build up a map of the response delay for each region of the wind. The settings to govern that can be found in the <code class="docutils literal notranslate"><span class="pre">###</span> <span class="pre">Parameters</span> <span class="pre">for</span> <span class="pre">Reverberation</span> <span class="pre">Modeling</span></code> section of the <code class="docutils literal notranslate"><span class="pre">.pf</span></code> file.</p>
<section id="reverb.pf">
<h4>reverb.pf<a class="headerlink" href="#reverb.pf" title="Permalink to this heading"></a></h4>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>### Parameters for Reverberation Modeling (if needed)
Reverb.type(none,photon,wind,matom)               wind
Reverb.disk_type(correlated,uncorrelated,ignore)  ignore
Reverb.path_bins                                  100
Reverb.visualisation(none,vtk,dump,both)          none
Reverb.filter_lines(0=off,-1=continuum,&gt;0=count)  -1
</pre></div>
</div>
<p>There are several <code class="docutils literal notranslate"><span class="pre">Reverb.type</span></code> modes that can be used for this, but the standard one is <code class="docutils literal notranslate"><span class="pre">wind</span></code>. This handles emission in the wind by assigning photons generated there a delay compared to the central source drawn from the distribution of delays of those photons that contributed to the heating &amp; ionisation state of that region of the wind. This distribution is discretised in <code class="docutils literal notranslate"><span class="pre">Reverb.path_bins</span></code> bins; in this example we use <code class="docutils literal notranslate"><span class="pre">100</span></code> but <code class="docutils literal notranslate"><span class="pre">1000</span></code> is more suitable for real applications.</p>
<p>Values that are too low will result in clear ‘striping’ in the transfer functions, whilst values that are too high give no real benefit and result in increased memory overhead (as each cell in the wind contains a <code class="docutils literal notranslate"><span class="pre">path_bins</span></code>-length array of doubles).</p>
</section>
<section id="Line-Filtering">
<h4>Line Filtering<a class="headerlink" href="#Line-Filtering" title="Permalink to this heading"></a></h4>
<p>An important setting is <code class="docutils literal notranslate"><span class="pre">Reverb.filter_lines</span></code>. If this is set to <code class="docutils literal notranslate"><span class="pre">0</span></code>, <em>every</em> single photon that contributes to every single spectrum (including the pseudo-photons generated after each scattering event in <code class="docutils literal notranslate"><span class="pre">extract</span></code> mode). This produces unwieldy and incredibly vast output files! The <code class="docutils literal notranslate"><span class="pre">-1</span></code> filter mode instead includes only those photons whose last interaction was a line scatter or line emission. This produces large, but less overwhelming output files.</p>
<p><code class="docutils literal notranslate"><span class="pre">Reverb.filter_lines</span> <span class="pre">N</span></code> allows the user to include <code class="docutils literal notranslate"><span class="pre">N</span></code> different <code class="docutils literal notranslate"><span class="pre">Reverb.filter_line</span> <span class="pre">X</span></code> lines, where <code class="docutils literal notranslate"><span class="pre">X</span></code> is the internal <code class="docutils literal notranslate"><span class="pre">Python</span></code> data file line number for the line. This is a bit clunky and is easiest done by exploring the output files. This exploratory process is covered later on.</p>
<p>Ideally, this could be done in the input file by specifying the transition by species, upper and lower lines.</p>
</section>
</section>
<section id="Running-the-Model">
<h3>Running the Model<a class="headerlink" href="#Running-the-Model" title="Permalink to this heading"></a></h3>
<p>If you’d like to run <code class="docutils literal notranslate"><span class="pre">Python</span></code> directly through this notebook, you’ll have to make sure whatever virtual environment you’re running it in has access to the <code class="docutils literal notranslate"><span class="pre">Python</span></code> executables, and set the notebook itself to be trusted using <code class="docutils literal notranslate"><span class="pre">jupyter</span> <span class="pre">trust</span> <span class="pre">reverb.ipynb</span></code>. Then:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">subprocess</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;reverb.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;mpirun&#39;</span><span class="p">,</span> <span class="s1">&#39;-np&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;py&#39;</span><span class="p">,</span> <span class="s1">&#39;reverb&#39;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">output_file</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Or alternatively, run it manually on the command line as:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mpirun<span class="w"> </span>-np<span class="w"> </span><span class="m">4</span><span class="w"> </span>py<span class="w"> </span>reverb<span class="w"> </span><span class="p">&amp;</span>&gt;<span class="w"> </span>reverb.txt
</pre></div>
</div>
<p>This will write one <code class="docutils literal notranslate"><span class="pre">reverb.delay_dump</span></code> file per thread, and concatenate them together. If run in serial you should see the following message once it finishes:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat:<span class="w"> </span><span class="s1">&#39;reverb_high.delay_dump[0-9]*&#39;</span>:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory
rm:<span class="w"> </span>cannot<span class="w"> </span>remove<span class="w"> </span><span class="s1">&#39;reverb_high.delay_dump[0-9]*&#39;</span>:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory
</pre></div>
</div>
<p>This can be ignored. Ideally, this would all be done directly to <strong>HDF5</strong> or <strong>SQLite</strong> or a similar file format but that’s yet to be implemented.</p>
</section>
<section id="Processing-the-Data">
<h3>Processing the Data<a class="headerlink" href="#Processing-the-Data" title="Permalink to this heading"></a></h3>
<p>Processing the data involves using the <code class="docutils literal notranslate"><span class="pre">py4py.reverb</span></code> module provided in the <code class="docutils literal notranslate"><span class="pre">py_progs</span></code> directory. You can install this into your virtual environment using <code class="docutils literal notranslate"><span class="pre">pip</span></code>. This works by processing the very large flat text <code class="docutils literal notranslate"><span class="pre">.delay_dump</span></code> files into a <strong>SQLite</strong> database for further processing. This is done by:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">from</span> <span class="nn">py4py.reverb</span> <span class="kn">import</span> <span class="n">open_database</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">open_database</span><span class="p">(</span><span class="s1">&#39;reverb&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Opening database &#39;reverb&#39;...
Found existing filled photon database &#39;reverb&#39;
</pre></div></div>
</div>
<p>You should see the output</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Opening<span class="w"> </span>database<span class="w"> </span><span class="s1">&#39;reverb&#39;</span>...
No<span class="w"> </span>existing<span class="w"> </span>filled<span class="w"> </span>photon<span class="w"> </span>database,<span class="w"> </span>reading<span class="w"> </span>from<span class="w"> </span>file<span class="w"> </span><span class="s1">&#39;reverb.delay_dump&#39;</span>:
Successfully<span class="w"> </span><span class="nb">read</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">([</span>Time<span class="o">]</span>s<span class="o">)</span>
</pre></div>
</div>
<p>If there are errors during reading, this will leave a malformed <code class="docutils literal notranslate"><span class="pre">reverb.db</span></code> database- to restart generation with a fixed DB file, you’ll have to delete the <code class="docutils literal notranslate"><span class="pre">reverb.db</span></code> file.</p>
<p>Once the database has been built, you can begin producing transfer functions. Each is only meaningful for a single emission line, so you need the <code class="docutils literal notranslate"><span class="pre">python</span></code> line number. This is an internal number that depends on your choice of data files. In practical terms, the easiest way to determine it is to filter the output data file by its second (<code class="docutils literal notranslate"><span class="pre">Lambda</span></code>, wavelength in <span class="math notranslate nohighlight">\(\mathring{A}\)</span>) column to get the last (<code class="docutils literal notranslate"><span class="pre">Res.</span></code> for resonance) column, e.g. to find the <span class="math notranslate nohighlight">\(C_{IV}\)</span> line you would do
something like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>awk<span class="w"> </span><span class="s1">&#39;{if($2&lt;1551 &amp;&amp; $2&gt;1549)print}&#39;</span><span class="w"> </span>&lt;<span class="w"> </span>reverb.delay_dump
</pre></div>
</div>
<p>This should give an output along the lines of the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">1</span>.9339e+15<span class="w">     </span><span class="m">1550</span>.205<span class="w">  </span><span class="m">5</span>.916e+35<span class="w"> </span>+3.2373e+16<span class="w"> </span>+2.527e+16<span class="w"> </span>-2.0825e+15<span class="w">   </span><span class="m">0</span><span class="w">       </span><span class="m">0</span><span class="w">     </span><span class="m">2</span>.3796e+06<span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">3</span><span class="w">   </span><span class="m">417</span>
<span class="m">1</span>.9343e+15<span class="w">     </span><span class="m">1549</span>.889<span class="w"> </span><span class="m">1</span>.9913e+35<span class="w"> </span>+1.456e+16<span class="w"> </span>-2.1381e+15<span class="w"> </span>+1.1648e+14<span class="w">   </span><span class="m">0</span><span class="w">       </span><span class="m">0</span><span class="w">     </span><span class="m">7</span>.8831e+05<span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">3</span><span class="w">   </span><span class="m">418</span>
<span class="w"> </span><span class="m">1</span>.934e+15<span class="w">     </span><span class="m">1550</span>.089<span class="w"> </span><span class="m">3</span>.7613e+35<span class="w"> </span>+1.8536e+16<span class="w"> </span>-2.8783e+15<span class="w"> </span>+4.1224e+14<span class="w">   </span><span class="m">0</span><span class="w">       </span><span class="m">0</span><span class="w">     </span><span class="m">1</span>.0195e+06<span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">3</span><span class="w">   </span><span class="m">418</span>
<span class="w"> </span><span class="m">1</span>.934e+15<span class="w">     </span><span class="m">1550</span>.078<span class="w"> </span><span class="m">1</span>.3523e+36<span class="w"> </span>-2.0765e+16<span class="w"> </span>-2.4398e+16<span class="w"> </span>+2.5734e+15<span class="w">   </span><span class="m">2</span><span class="w">       </span><span class="m">1</span><span class="w">     </span><span class="m">9</span>.1914e+05<span class="w">     </span><span class="m">0</span><span class="w">    </span><span class="m">13</span><span class="w">   </span><span class="m">418</span>
</pre></div>
</div>
<p>This would suggest that the doublet covers lines <code class="docutils literal notranslate"><span class="pre">417</span></code> and <code class="docutils literal notranslate"><span class="pre">418</span></code>. We can take this number and use it to generate a transfer function as</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4py.reverb</span> <span class="kn">import</span> <span class="n">TransferFunction</span>

<span class="n">c_4</span> <span class="o">=</span> <span class="n">TransferFunction</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;C-IV&#39;</span><span class="p">,</span> <span class="n">continuum</span><span class="o">=</span><span class="mf">1e43</span><span class="o">+</span><span class="mf">9.20e43</span><span class="p">,</span> <span class="n">wave_bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">delay_bins</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="mi">418</span><span class="p">,</span> <span class="mi">1550</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">spectrum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">delay_dynamic_range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;C-IV&#39; successfully run (0.0s)
</pre></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">TransferFunction</span></code> initialiser accepts several arguments:</p>
<ul class="simple">
<li><p>The database opened earlier, the name of the transfer function (in this case <code class="docutils literal notranslate"><span class="pre">C-IV</span></code>).</p></li>
<li><p>The continuum luminosity used to generate it (central source <strong>plus</strong> disk continuum).</p></li>
<li><p>The number of bins in time (<code class="docutils literal notranslate"><span class="pre">delay_bins</span></code>) and wavelength (<code class="docutils literal notranslate"><span class="pre">wave_bins</span></code>) for the transfer function.</p></li>
</ul>
<p>The photons used to generate this transfer function are then limited by a set of functions:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">line()</span></code> function limits the produced transfer function to only include photons in the specific line. The wavelength of the line is also needed- ideally, it would be possible to get this straight from the <code class="docutils literal notranslate"><span class="pre">Python</span></code> atomic data files eventually.</p></li>
<li><p>As the data file contains multiple spectra, we select one with <code class="docutils literal notranslate"><span class="pre">spectrum()</span></code>, providing the spectrum number (1-indexed).</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">delay_dynamic_range()</span></code> function limits the range of delays used to calculate the delay bins. Normally, the code will generate <code class="docutils literal notranslate"><span class="pre">delay_bins</span></code> number of bins between <code class="docutils literal notranslate"><span class="pre">0</span></code> and the longest delay in the dataset. However, for models with dense regions, there can be a very long tail of photon delays, such that setting the bins to include <em>all</em> photons means condensing 90%+ of the delay distribution into a small number of bins. Instead, the <code class="docutils literal notranslate"><span class="pre">delay_dynamic_range()</span></code> function caps the delay at
the <span class="math notranslate nohighlight">\(1-10^{argument}\)</span>th percentile, i.e. <code class="docutils literal notranslate"><span class="pre">delay_dynamic_range(3)</span></code> means the transfer function will cover 99.9% of the range of photon delays.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">run()</span></code> function queries the photons on disk and bins them to produce the transfer function. The <code class="docutils literal notranslate"><span class="pre">limit</span></code> parameter caps the query at <code class="docutils literal notranslate"><span class="pre">argument</span></code> photons. As a full query can run to multiple minutes, you can run quick tests using the <code class="docutils literal notranslate"><span class="pre">limit</span></code> parameter!</p></li>
</ul>
<p>Once the data has been processed using <code class="docutils literal notranslate"><span class="pre">run()</span></code>, you can plot it.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c_4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span>
    <span class="n">keplerian</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;angle&#39;</span><span class="p">:</span> <span class="mf">40.0</span><span class="p">,</span> <span class="s1">&#39;mass&#39;</span><span class="p">:</span> <span class="mf">1e7</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1500</span><span class="p">,</span> <span class="mi">3000</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;C-IV.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Plotting to file &#39;C-IV.eps&#39;...
Total line: 4.490e-06
Successfully plotted &#39;C-IV.eps&#39;(1.3s)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_reverb_reverb_7_1.png" src="../../_images/examples_reverb_reverb_7_1.png" />
</div>
</div>
<p>You can overlay a plot of the expected envelope for a Keplerian rotating disk by passing a dictionary as an argument to plot:</p>
<ul class="simple">
<li><p><strong>angle:</strong> The angle of observation</p></li>
<li><p><strong>mass:</strong> The central object mass</p></li>
<li><p><strong>radius:</strong> The inner and outer disk radii in terms of the central object <span class="math notranslate nohighlight">\(r_g\)</span> (<span class="math notranslate nohighlight">\(2\times r_\mathrm{schwartzchild}\)</span>)</p></li>
</ul>
<p>By default, the transfer function is output to disk (as it can take a very long time to run and there’s no point risking people accidentally not saving it!). Satisfied that the transfer function has been generated successfully and looks relatively OK, we can create one with the full dataset. If we call <code class="docutils literal notranslate"><span class="pre">run()</span></code> again without a <code class="docutils literal notranslate"><span class="pre">limit</span></code> parameter, the output TF will use the same delay and wavelength bins. We’ll create a new one from scratch just to be sure (as the 99.9th% of the first 1000
photons may differ a bit from the full set).</p>
<p>Given the previous TF appears to have a fairly long and weak outflow signature, it is reasonable to reduce the dynamic range a bit. The relatively small size of the input file as well means we should reduce the number of bins.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c_4</span> <span class="o">=</span> <span class="n">TransferFunction</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;C-IV&#39;</span><span class="p">,</span> <span class="n">continuum</span><span class="o">=</span><span class="mf">1e43</span><span class="o">+</span><span class="mf">9.20e43</span><span class="p">,</span> <span class="n">wave_bins</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">delay_bins</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="mi">418</span><span class="p">,</span> <span class="mi">1550</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">spectrum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">delays</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">wavelengths</span><span class="p">(</span><span class="mi">1500</span><span class="p">,</span> <span class="mi">1600</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">scaling_factor</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;C-IV&#39; successfully run (1.8s)
</pre></div></div>
</div>
<ul class="simple">
<li><p>Instead of using the dynamic range, we can set the delay range manually. We’ll select 2000 days as most of the features fall in this range.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">scaling_factor</span></code> parameter is used to account for the fact that the full photon DB is built up of photons from many spectral cycles. You <strong>must</strong> provide a scaling factor equal to 1/<code class="docutils literal notranslate"><span class="pre">Spectrum_cycles</span></code>. Ideally, this would be caught from the input <code class="docutils literal notranslate"><span class="pre">.pf</span></code> file automatically.</p></li>
</ul>
<p>Now we can actually plot the final transfer function. For this, we will pass the <code class="docutils literal notranslate"><span class="pre">velocity=True</span></code> argument to plot to show the velocity shift on the line emission:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c_4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span>
    <span class="n">keplerian</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;angle&#39;</span><span class="p">:</span> <span class="mf">40.0</span><span class="p">,</span> <span class="s1">&#39;mass&#39;</span><span class="p">:</span> <span class="mf">1e7</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1500</span><span class="p">,</span> <span class="mi">3000</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="n">velocity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;C-IV.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Plotting to file &#39;C-IV.eps&#39;...
Total line: 1.529e-04
Successfully plotted &#39;C-IV.eps&#39;(1.0s)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_reverb_reverb_11_1.png" src="../../_images/examples_reverb_reverb_11_1.png" />
</div>
</div>
</section>
<section id="Intepreting-the-Transfer-Function">
<h3>Intepreting the Transfer Function<a class="headerlink" href="#Intepreting-the-Transfer-Function" title="Permalink to this heading"></a></h3>
<p>The velocity-delay plane projects information on both the kinematics and geometry of the system, but in a way that is not necessarily easy to interpret. Two-dimensional transfer functions have <em>less</em> degeneracy than one-dimensional ones, but not <em>no</em> degeneracy. In addition, different behavious may appear at different timescales; in particular, in systems with both outflow and rotation will exhibit unusual behaviour around the regions where the outflow and Keplerian velocities are equivalent.</p>
<ul class="simple">
<li><p>Diagonal features, with a ‘gap’ in the bottom-right section (highly red-shifted at short delays), a.k.a. blue-leads-red, are associated with outflows.</p>
<ul>
<li><p>Any highly red-shifted material has to have been reprocessed in the outflows heading away from the observer; thus, the travel time for this is longer.</p></li>
<li><p>These typically also have a gap in the top-left section of the transfer function (highly blue-shifted at short delays). In classic reverberation models this is a crisp, well-defined line. Taking multiple-scattering into account, photons from any position in the wind can be reprocessed again in the outflow region; so this region bleeds upwards.</p></li>
<li><p><strong>However:</strong> Be aware that these signatures might be convolved with rotation (see below).</p></li>
</ul>
</li>
<li><p>Oval features are associated with Keplerian rotation.</p>
<ul>
<li><p>‘Squashed’ ovals, with high red- &amp; blue-shift at short delays, are typically disk or wind inner edges of reprocessing material in Keplerian rotation. The closer material is to the central object, the faster it rotates. Again, classic reverberation models have very crisp edges to these signatures, but multiple-scattering will smear them out in our code.</p></li>
<li><p>‘Tall’ ovals, with low red- &amp; blue-shift at delays ranging from short to long, are typically disk or wind outer edges. As before, these signatures are less crisp than classical ones due to multiple-scattering. Emission typically falls off in the middle of the oval, and drops dramatically beyond it.</p>
<ul>
<li><p>If there is no distinct edge, just a smooth falloff, this is likely due to the reprocessing region extending off beyond the region at which the falloff due to distance from the central source reduces the response to zero.</p></li>
</ul>
</li>
<li><p><strong>However:</strong> Be aware that these signatures might be convolved with outflow (see below).</p></li>
</ul>
</li>
<li><p>‘Tilted tall’ ovals are associated with Keplerian rotation convolved with outflow.</p>
<ul>
<li><p>These arise due to the interaction between outflow and Keplerian rotation. Those regions that are furthest from the observer (i.e. at longest delays) are the most red-shifted, and those that are at short delays are the most blue-shifted.</p></li>
<li><p>See <a class="reference external" href="https://arxiv.org/abs/1707.07687">Mangham 2018</a> for more details, as this is quite hard to explain without a good image.</p></li>
<li><p>Crucially, over short distances these can <em>appear</em> to display blue-leads-red signatures at low resolution.</p></li>
</ul>
</li>
</ul>
<p>The transfer function above shows clear signs of keplerian rotation with an oval inner-edge signature. However, there is no distinct longer-delay outer edge signature, suggesting that emission is not from a well-defined disk with a hard edge but that it tails out slowly. There is also a small blue-leads-red signature, more visible if the transfer function is plotted with a logarithmic response, with a slight ‘diagonal’ signature visible. This suggests that the kinematics of the emission region
are largely rotationally-dominated with a hint of outflow. Notably, this does not imply that the entire system <strong>itself</strong> is rotationally dominated or in outflow, simply that the kinematics of the material that is emitting in <span class="math notranslate nohighlight">\(C_\mathrm{IV}\)</span> are so.</p>
<p>If our initial run didn’t provide enough detail, we can create a new file with more spectral cycles, and limit it to output only the photons we want to keep the file size down, for example as below to keep only the <span class="math notranslate nohighlight">\(C_\mathrm{IV}\)</span> photons from the upper line of the doublet:</p>
<section id="reverb_extended.py">
<h4>reverb_extended.py<a class="headerlink" href="#reverb_extended.py" title="Permalink to this heading"></a></h4>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>### Parameters associated with photon number, cycles,ionization and radiative transfer options
[...]
Spectrum_cycles                            50
[...]

### Parameters for Reverberation Modeling (if needed)
[...]
Reverb.filter_lines                        1
Reverb.filter_line                         418
</pre></div>
</div>
</section>
</section>
</section>
<section id="Responsivity-Weighted-Transfer-Function">
<h2>Responsivity-Weighted Transfer Function<a class="headerlink" href="#Responsivity-Weighted-Transfer-Function" title="Permalink to this heading"></a></h2>
<p>The basic transfer function generated is more properly the <strong>‘emissivity-weighted’</strong> transfer function; it assumes that there are no changes in ionisation state in the wind, and that a 10% increase in central source luminosity results in a 10% increase in reprocessed luminosity in the wind. Given observations of the breathing BLR in AGN or of periods of anticorrelation between continuum and Hα luminosity in the AGN NGC5548, this is unlikely to be true!</p>
<p><code class="docutils literal notranslate"><span class="pre">Python</span></code> can produce <strong>responsivity-weighted</strong> transfer functions, A.K.A ‘response functions’. It does this by performing two separate runs of models that bracket the main model in luminosity, and approximates the response function at the central luminosity by using the gradient between the two transfer functions. We produce two copies of the main model, each with all sources of luminosity adjusted up and down by the same value. Typically we choose 10%, assuming that the responsivity is
constant across this region. As the regions of peak response typically move through the wind with changing luminosity (e.g. ionisation fronts being pushed back when continuum luminosity increases), selecting too large a bracket can result in issues with the emitting wind regions failing to overlap.</p>
<section id="Building-the-Models">
<h3>Building the Models<a class="headerlink" href="#Building-the-Models" title="Permalink to this heading"></a></h3>
<p>So we create two new copies of the file <code class="docutils literal notranslate"><span class="pre">reverb.pf</span></code>, <code class="docutils literal notranslate"><span class="pre">reverb_low.pf</span></code> and <code class="docutils literal notranslate"><span class="pre">reverb_high.pf</span></code>.</p>
<p>The original lines in reverb.pf are:</p>
<section id="id1">
<h4>reverb.pf<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h4>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>### Parameters for the Disk (if there is one)
[...]
Disk.mdot(msol/yr)                         0.02
[...]

### Parameters for Boundary Layer or the compact object in an X-ray Binary or AGN
[...]
Central_object.luminosity(ergs/s)          1e43
[...]

### Parameters for Reverberation Modeling (if needed)
[...]
Reverb.filter_lines(0=off,-1=continuum,&gt;0=count)   -1
</pre></div>
</div>
<p>In our low and high versions of the file (in the same directory), they are:</p>
</section>
<section id="reverb_low.pf">
<h4>reverb_low.pf<a class="headerlink" href="#reverb_low.pf" title="Permalink to this heading"></a></h4>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>### Parameters for the Disk (if there is one)
[...]
Disk.mdot(msol/yr)                         0.018
[...]

### Parameters for Boundary Layer or the compact object in an X-ray Binary or AGN
[...]
Central_object.luminosity(ergs/s)          0.9e43
[...]

### Parameters for Reverberation Modeling (if needed)
[...]
Reverb.filter_lines                        1
Reverb.filter_line                         418
</pre></div>
</div>
</section>
<section id="reverb_high.pf">
<h4>reverb_high.pf<a class="headerlink" href="#reverb_high.pf" title="Permalink to this heading"></a></h4>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>### Parameters for the Disk (if there is one)
[...]
Disk.mdot(msol/yr)                         0.022
[...]

### Parameters for Boundary Layer or the compact object in an X-ray Binary or AGN
[...]
Central_object.luminosity(ergs/s)          1.1e43
[...]

### Parameters for Reverberation Modeling (if needed)
[...]
Reverb.filter_lines                        1
Reverb.filter_line                         418
</pre></div>
</div>
<p><strong>NOTE:</strong> You may have to change the <code class="docutils literal notranslate"><span class="pre">Reverb.filter_line</span></code> entry if the line number you found earlier is different. Line numbers <em>depend on the data files</em>, so any update to the data files may change the line numbers.</p>
<p>These two runs are used to calculate the response function. The final response function will <em>only</em> use the output of these two, and not use any of the photons used to generate the transfer function, so you may want to increase the number of photons run. However, for diagnostic purposes it’s useful to generate a response functions from each pair (<code class="docutils literal notranslate"><span class="pre">-10%</span> <span class="pre">→</span> <span class="pre">+10%</span></code>, <code class="docutils literal notranslate"><span class="pre">-10%</span> <span class="pre">→</span> <span class="pre">0%</span></code>, <code class="docutils literal notranslate"><span class="pre">0%</span> <span class="pre">→</span> <span class="pre">10%</span></code>); any substantial differences between them will highlight that you’re at a point of inflection in the
ionisation profile.</p>
<p>Given we know which emission line number we’re looking for now, we can set the filter to exclude all other photons from being stored using <code class="docutils literal notranslate"><span class="pre">Reverb.filter_lines</span></code>; this will dramatically reduce the file-size.</p>
</section>
</section>
<section id="Running-the-Models">
<h3>Running the Models<a class="headerlink" href="#Running-the-Models" title="Permalink to this heading"></a></h3>
<p>Now, we run these two models as well. They’ll similarly output one <code class="docutils literal notranslate"><span class="pre">reverb_[low/high].delay_dump[thread]</span></code> file per thread, which will be concatenated together at the end of the run to produce a single <code class="docutils literal notranslate"><span class="pre">reverb_[low/high].delay_dump</span></code> file.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;mpirun -np 8 py reverb_low.pf &gt; reverb_low.txt&quot;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;mpirun -np 8 py reverb_high.pf &gt; reverb_high.txt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>You may want to change the number of processors used, depending on your system.</p>
</section>
<section id="id2">
<h3>Processing the Data<a class="headerlink" href="#id2" title="Permalink to this heading"></a></h3>
<p>Now, we need to go back to the <code class="docutils literal notranslate"><span class="pre">py4py.reverb</span></code> package. Each one of the new runs needs to be processed into a <strong>sqlite</strong> database, and we can then produce a response function from them. We can base the analysis on the previously-made <code class="docutils literal notranslate"><span class="pre">TransferFunction</span></code> as</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4py.reverb</span> <span class="kn">import</span> <span class="n">TransferFunction</span>

<span class="n">db_low</span> <span class="o">=</span> <span class="n">open_database</span><span class="p">(</span><span class="s1">&#39;reverb_low&#39;</span><span class="p">)</span>
<span class="n">c_4_low</span> <span class="o">=</span> <span class="n">TransferFunction</span><span class="p">(</span><span class="n">db_low</span><span class="p">,</span> <span class="s1">&#39;C-IV_high&#39;</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="n">c_4</span><span class="p">,</span> <span class="n">continuum</span><span class="o">=</span><span class="mf">0.9e43</span><span class="o">+</span><span class="mf">8.29e43</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">delay_dynamic_range</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">scaling_factor</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span>

<span class="n">db_high</span> <span class="o">=</span> <span class="n">open_database</span><span class="p">(</span><span class="s1">&#39;reverb_high&#39;</span><span class="p">)</span>
<span class="n">c_4_high</span> <span class="o">=</span> <span class="n">TransferFunction</span><span class="p">(</span><span class="n">db_high</span><span class="p">,</span> <span class="s1">&#39;C-IV_high&#39;</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="n">c_4</span><span class="p">,</span> <span class="n">continuum</span><span class="o">=</span><span class="mf">1.1e43</span><span class="o">+</span><span class="mf">1.01e44</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">delay_dynamic_range</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">scaling_factor</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span>

<span class="n">c_4</span><span class="o">.</span><span class="n">response_map_by_tf</span><span class="p">(</span><span class="n">c_4_low</span><span class="p">,</span> <span class="n">c_4_high</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;resp&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">response_map</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">keplerian</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;angle&#39;</span><span class="p">:</span> <span class="mf">40.0</span><span class="p">,</span> <span class="s1">&#39;mass&#39;</span><span class="p">:</span> <span class="mf">1e7</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1500</span><span class="p">,</span> <span class="mi">3000</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;C-IV_resp.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Opening database &#39;reverb_low&#39;...
Found existing filled photon database &#39;reverb_low&#39;
Templating &#39;C-IV_high&#39; off of &#39;C-IV&#39;...
&#39;C-IV_high&#39; successfully run (1.2s)
Opening database &#39;reverb_high&#39;...
Found existing filled photon database &#39;reverb_high&#39;
Templating &#39;C-IV_high&#39; off of &#39;C-IV&#39;...
&#39;C-IV_high&#39; successfully run (1.0s)
Plotting to file &#39;C-IV_resp.eps&#39;...
Total response: 2.435e-03
Successfully plotted &#39;C-IV_resp.eps&#39;(0.9s)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_reverb_reverb_16_1.png" src="../../_images/examples_reverb_reverb_16_1.png" />
</div>
</div>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">template=</span></code> argument is required to produce a response function. A templated <code class="docutils literal notranslate"><span class="pre">TransferFunction</span></code> will share the same wavelength and delay bins, along with the same line and spectrum.</p></li>
<li><p>The argument <code class="docutils literal notranslate"><span class="pre">template_different_line=True</span></code> can be passed when declaring a new <code class="docutils literal notranslate"><span class="pre">TransferFunction</span></code>. This can be used to ensure consistency between e.g. <span class="math notranslate nohighlight">\(C_{IV}\)</span> and <span class="math notranslate nohighlight">\(H\alpha\)</span> transfer/response function plots. These will share the same <em>velocity</em> bins, delay bins and spectrum.</p></li>
<li><p>Once the two <code class="docutils literal notranslate"><span class="pre">TransferFunction</span></code>s for the different continuum values have been generated, we subtract the two and divide by <span class="math notranslate nohighlight">\(\Delta C\)</span>. This assumes that the difference in line response is linear across <span class="math notranslate nohighlight">\(\Delta C\)</span>!</p></li>
<li><p>Notably, whilst the response function data is stored on the template <code class="docutils literal notranslate"><span class="pre">TransferFunction</span></code> object, none of that object’s transfer function data is used to calculate it.</p></li>
</ul>
</section>
<section id="Interpreting-the-Response-Function">
<h3>Interpreting the Response Function<a class="headerlink" href="#Interpreting-the-Response-Function" title="Permalink to this heading"></a></h3>
<p>Critically, unlike transfer functions, response functions can have both positive and negative regions. <code class="docutils literal notranslate"><span class="pre">py4py</span></code> by default uses <strong>red</strong> to indicate regions of positive response and <strong>blue</strong> to indicate regions of negative response.</p>
<ul class="simple">
<li><p>Naively, we would expect the response function to have the same distribution as the transfer function; if plotted with <code class="docutils literal notranslate"><span class="pre">rescaled=True</span></code> (such that the maximum value in any given bin is 1) the two should be identical. If the response profile of the wind differs at all across the interval <span class="math notranslate nohighlight">\(\Delta C\)</span>, then the response function should be different.</p></li>
<li><p>As the luminosity of the central source increases, this can push ionisation fronts back into the wind. This can result in a <strong>reduction</strong> in response at low delays and high Doppler shifts.</p></li>
<li><p>It can also result in over-ionization of low-density extended wind regions. This shows most clearly as a <strong>reduction</strong> in the response at long delays.</p></li>
<li><p>In some models, there can in fact be a net negative response. It can be difficult to gauge this from the response function, but if this is the case it should be shown on the relative line increase against the global responsivity <span class="math notranslate nohighlight">\(\frac{\Delta L}{L}/\frac{\Delta C}{C}\)</span>. Naively, a 10% increase in continuum should result in a 10% increase in line luminosity giving a value of 1, a negative value indicates a reduction in line luminosity with increasing luminosity.</p></li>
</ul>
<p>For a response function to work, both runs used to produce it need to fully sample the whole velocity-delay space, otherwise spurious positive and negative responses are visible based solely on the presence or absence of photons in any given bin.</p>
<p>This response function is relatively well-behaved. It closely tracks the emissivity map, indicating that (for this system) the traditional assumptions of reverberation mapping hold. The response is strong at low delays and around the line of Keplerian rotation, and line emissivity increases at a substantially higher rate than continuum emissivity. This suggests that the inner wind is in a relatively low ionisation state and that increasing luminosity affects it significantly, substantially
increasing the proportion of <span class="math notranslate nohighlight">\(C_{IV}\)</span>.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../../examples.html" class="btn btn-neutral float-left" title="Examples" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../demo-models/quasar/quasar.html" class="btn btn-neutral float-right" title="Demo: Quasar, M20" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2023, Knox Long, Christian Knigge, Stuart Sim, Nick Higginbottom, James Matthews, Sam Mangham, Edward Parkinson, Mandy Hewitt.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>