<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Issues with Generating Spectra &mdash; python 88a documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Plotting &amp; Processing Outputs" href="../plotting.html" />
    <link rel="prev" title="Spectra Files" href="spectrum_files.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            python
          </a>
              <div class="version">
                88
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quick.html"><em>Quick Guide to Python</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../running_python.html">Running Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input.html">Inputs</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../output.html">Outputs &amp; Evaluation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="diagnostics.html">Diagnostic files</a></li>
<li class="toctree-l2"><a class="reference internal" href="evaluation.html">Evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="model.html">Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="spectrum_files.html">Spectra Files</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Issues with Generating Spectra</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../plotting.html">Plotting &amp; Processing Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation.html">Code Operation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../radiation.html">Radiation Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wind_models.html">Wind Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coordinate.html">Coordinate grids</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics.html">Physics &amp; Radiative Transfer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../atomic.html">Atomic Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../meta.html">Meta-documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer.html">Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_progs.html">Python Scripts</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">python</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../output.html">Outputs &amp; Evaluation</a></li>
      <li class="breadcrumb-item active">Issues with Generating Spectra</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/output/spectrum_generation_large_optical_depth.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="issues-with-generating-spectra">
<h1>Issues with Generating Spectra<a class="headerlink" href="#issues-with-generating-spectra" title="Permalink to this heading"></a></h1>
<p>With the current machinery to create spectra, it is possible to come across the
situation where models with large optical depth or wind velocities will generate
spectra with different flux normalisation depending on the wavelength range.</p>
<p>This problem was originally encountered whilst modelling Tidal Disruption Events.
Two spectra for the same model were generated over two wavelength ranges; a
restricted (1100 - 2600 A) and a broader (500 - 5000 A) range. The problem
encountered was that the broad range spectrum had <em>more</em> flux than the spectrum
with the restricted range. The figure below shows the same model, but over two
wavelength ranges - as well as two spectra where the maximum number of scatters
a photon can undergo is changed,</p>
<ul class="simple">
<li><p><strong>tde_flux_small_range:</strong> The restricted wavelength range</p></li>
<li><p><strong>tde_flux_large_range:</strong> The broad wavelength range</p></li>
<li><p><strong>tde_flux_small_range_maxscat:</strong> The restricted wavelength range with a value <code class="code docutils literal notranslate"><span class="pre">MAXSCAT</span> <span class="pre">=</span> <span class="pre">50</span></code></p></li>
<li><p><strong>tde_flux_no_maxscat:</strong> The restricted wavelength range with no <code class="code docutils literal notranslate"><span class="pre">MAXSCAT</span></code> limit</p></li>
</ul>
<figure class="align-default" id="id1">
<img alt="../_images/spectrum_generation_large_optical_depth.png" src="../_images/spectrum_generation_large_optical_depth.png" />
<figcaption>
<p><span class="caption-text">Example spectra showing differing flux totals</span><a class="headerlink" href="#id1" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>The problem here is not caused by a bug with the code, but is a consequence of
the large wind velocities and optical depths of the model. We currently believe
that there are two reasons why the flux differs between these two wavelength ranges.</p>
<section id="doppler-shifting-out-of-the-spectrum-wavelength-range">
<h2>Doppler Shifting out of the Spectrum Wavelength Range<a class="headerlink" href="#doppler-shifting-out-of-the-spectrum-wavelength-range" title="Permalink to this heading"></a></h2>
<p>At the edges of the restricted spectrum above, the flux is reduced. This is
due to photon frequencies being shifted outside of the wavelength range of the
spectrum. If a significant number of photons are removed from the spectrum
in this way, then the following Error is printed,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spectrum_create</span><span class="p">:</span> <span class="n">Fraction</span> <span class="n">of</span> <span class="n">photons</span> <span class="n">lost</span><span class="p">:</span> <span class="mf">0.10</span> <span class="n">wi</span><span class="o">/</span> <span class="n">freq</span><span class="o">.</span> <span class="n">low</span><span class="p">,</span> <span class="mf">0.19</span> <span class="n">w</span><span class="o">/</span><span class="n">freq</span> <span class="n">hi</span>
</pre></div>
</div>
<p>This tells one the fraction of the photon sample which does not contribute towards
the spectrum due to to the photon frequencies being larger or smaller than the
defined spectrum range, due to Doppler shifting. In models with large wind
velocities (0.2 - 0.5 c) and a small spectral range, the fraction of photons lost
is large and the flux at the edge of generated spectra is reduced - as can be
seen above in the above figure. However, when the wind has a more moderate velocity,
the number of photons lost due to being shifted out of the range is much lower and
does not produce a noticeable effect on the flux normalisation of the spectra.</p>
</section>
<section id="removing-photons-due-to-too-many-scatters">
<h2>Removing Photons due to Too Many Scatters<a class="headerlink" href="#removing-photons-due-to-too-many-scatters" title="Permalink to this heading"></a></h2>
<p>As well as edge effects, flux can be lost due to photons being removed from the
photon sample due to scattering too many times. In Python, when a photon has undergone
<cite>MAXSCAT = 500</cite> scatters, a photon is assumed to have become stuck in the wind
and hence it is terminated and no longer tracked.</p>
<p>In models with large optical depths, the number of photons terminated in this way
can become large. During spectrum generation, these photons will never fully
escape the system but will only contribute partially to the spectrum due to
extract - they will never contribute if Live or Die is used instead.</p>
<p>At current, there is no logic to detect this and hence no error is given. However,
it is often insightful to read the output from the <cite>Photons contribution to the
various spectra</cite> table, as shown below,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Photons</span> <span class="n">contributing</span> <span class="n">to</span> <span class="n">the</span> <span class="n">various</span> <span class="n">spectra</span>
<span class="n">Inwind</span>   <span class="n">Scat</span>    <span class="n">Esc</span>     <span class="n">Star</span>    <span class="o">&gt;</span><span class="n">nscat</span>    <span class="n">err</span>    <span class="n">Absorb</span>   <span class="n">Disk</span>    <span class="n">sec</span>    <span class="n">Adiab</span><span class="p">(</span><span class="n">matom</span><span class="p">)</span>
     <span class="mi">0</span>       <span class="mi">0</span>    <span class="mi">3455</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>
     <span class="mi">0</span>       <span class="mi">0</span>    <span class="mi">3455</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>
     <span class="mi">0</span>       <span class="mi">0</span>     <span class="mi">427</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>
     <span class="mi">0</span>       <span class="mi">0</span>    <span class="mi">1598</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>
     <span class="mi">0</span>       <span class="mi">0</span>    <span class="mi">1430</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>
     <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>
     <span class="mi">0</span>       <span class="mi">0</span>    <span class="mi">3313</span>       <span class="mi">0</span>   <span class="mi">17209</span>       <span class="mi">0</span>     <span class="mi">169</span>       <span class="mi">0</span>       <span class="mi">0</span>       <span class="mi">0</span>
     <span class="mi">0</span>  <span class="mi">282914</span>  <span class="mi">487831</span>    <span class="mi">1474</span>       <span class="mi">0</span>       <span class="mi">0</span>     <span class="mi">129</span>  <span class="mi">223605</span>       <span class="mi">0</span>       <span class="mi">0</span>
     <span class="mi">0</span>  <span class="mi">441756</span>  <span class="mi">336514</span>    <span class="mi">2223</span>       <span class="mi">0</span>       <span class="mi">0</span>     <span class="mi">135</span>  <span class="mi">215325</span>       <span class="mi">0</span>       <span class="mi">0</span>
     <span class="mi">0</span>  <span class="mi">609395</span>  <span class="mi">180082</span>    <span class="mi">5677</span>       <span class="mi">0</span>       <span class="mi">0</span>      <span class="mi">94</span>  <span class="mi">200705</span>       <span class="mi">0</span>       <span class="mi">0</span>
     <span class="mi">0</span>  <span class="mi">750672</span>   <span class="mi">61308</span>   <span class="mi">12010</span>       <span class="mi">0</span>       <span class="mi">0</span>      <span class="mi">59</span>  <span class="mi">171904</span>       <span class="mi">0</span>       <span class="mi">0</span>
     <span class="mi">0</span>  <span class="mi">838923</span>   <span class="mi">26143</span>   <span class="mi">29057</span>       <span class="mi">0</span>       <span class="mi">0</span>      <span class="mi">55</span>  <span class="mi">101775</span>       <span class="mi">0</span>       <span class="mi">0</span>
</pre></div>
</div>
<p>In the above table, one can see that 17,209 photons which scattered more than
<code class="docutils literal notranslate"><span class="pre">MAXSCAT</span></code> times contributed to the the scattered spectrum, suggesting that a large
number of photons were terminated due to too many scatters.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The photon numbers presented in this table are only for the master MPI process. Hence, if
running in multiprocessor mode, the number here will never equal the total
number of photons in the simulation, but only the number of photons in the current
process.</p>
</div>
</section>
<section id="github-issue">
<h2>GitHub Issue<a class="headerlink" href="#github-issue" title="Permalink to this heading"></a></h2>
<p>The original <strong>GitHub</strong> issue discussing this problem can be found here; <a class="reference external" href="https://github.com/agnwinds/python/issues/471">#471</a>.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="spectrum_files.html" class="btn btn-neutral float-left" title="Spectra Files" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../plotting.html" class="btn btn-neutral float-right" title="Plotting &amp; Processing Outputs" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2024, Knox Long, Christian Knigge, Stuart Sim, Nick Higginbottom, James Matthews, Sam Mangham, Edward Parkinson, Mandy Hewitt, Nicolas Scepi, Austen Wallis, Amin Mosallanezhad.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>