<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Macro Atoms &mdash; python 88a documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Special Relativity and Co-Moving Frames" href="relativity_comoving.html" />
    <link rel="prev" title="Radiative Transfer Modes" href="radiative_transfer.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            python
          </a>
              <div class="version">
                88
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quick.html"><em>Quick Guide to Python</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../running_python.html">Running Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input.html">Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../output.html">Outputs &amp; Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plotting.html">Plotting &amp; Processing Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation.html">Code Operation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../radiation.html">Radiation Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wind_models.html">Wind Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coordinate.html">Coordinate grids</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Examples</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../physics.html">Physics &amp; Radiative Transfer</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="radiative_transfer.html">Radiative Transfer Modes</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Macro Atoms</a></li>
<li class="toctree-l2"><a class="reference internal" href="relativity_comoving.html">Special Relativity and Co-Moving Frames</a></li>
<li class="toctree-l2"><a class="reference internal" href="aniso.html">Anisotropic Scattering</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../atomic.html">Atomic Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../meta.html">Meta-documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer.html">Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_progs.html">Python Scripts</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">python</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../physics.html">Physics &amp; Radiative Transfer</a></li>
      <li class="breadcrumb-item active">Macro Atoms</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/physics/macroatoms.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="macro-atoms">
<h1>Macro Atoms<a class="headerlink" href="#macro-atoms" title="Permalink to this heading"></a></h1>
<div class="admonition-todo admonition" id="id1">
<p class="admonition-title">Todo</p>
<p>This page shoud contain a description of how macro atoms work. The below is copied from JM’s thesis.</p>
</div>
<div class="admonition-todo admonition" id="id2">
<p class="admonition-title">Todo</p>
<p>Add description of accelerated macro-atom scheme</p>
</div>
<p>The macro-atom scheme was created by Leon Lucy and is outlined in his 2002/03 papers. It was implemented in Python by Stuart Sim, initially for the study of recombination lines in YSOs (Sim et al. 2005).</p>
<p>Lucy (2002,2004) hereafter L02, L03 has shown that it is possible to calculate the emissivity of a gas in statistical equilibrium without approximation for problems with large departures from LTE. His <cite>macro-atom</cite> scheme allows for all possible transition paths from a given level, dispensing with the two-level approximation, and provides a full non-LTE solution for the level populations based on Monte Carlo estimators. The macro-atom technique has already been used to model Wolf-Rayet star winds (Sim 2004), AGN disc winds (Sim et al. 2008), supernovae (Kromer and Sim 2009, Kerzendorf and Sim 2014) and YSOs (Sim et al. 2005). A full description of the approach can be found in L02 and L03.</p>
<p>Following L02, let us consider an atomic species interacting with a radiation field. If the quantity <span class="math notranslate nohighlight">\(\epsilon_j\)</span> represents the ionization plus excitation energy of a level <span class="math notranslate nohighlight">\(j\)</span> then the rates at which the level absorbs and emits radiant energy are given by</p>
<div class="math notranslate nohighlight">
\[\dot{A}_{j}^{R} = R_{l j} \epsilon_{j l}\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[\dot{E}_{j}^{R} = R_{j l} \epsilon_{j l}\]</div>
<p>where <span class="math notranslate nohighlight">\(\epsilon_{j l} = \epsilon_j - \epsilon_l\)</span>.
Here, we have adopted Lucy’s convention, in which the subscript
<span class="math notranslate nohighlight">\(l\)</span> denotes a summation over all lower states (<span class="math notranslate nohighlight">\(&lt;j\)</span>), and
(<span class="math notranslate nohighlight">\(u\)</span>) a summation over all upper states (<span class="math notranslate nohighlight">\(&gt;j\)</span>).
Similarly, the rates corresponding to _kinetic_ (collisional)
energy transport can then be written as</p>
<div class="math notranslate nohighlight">
\[\dot{A}_{j}^{C} = C_{l j} \epsilon_{j l}\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[\dot{E}_{j}^{C} = C_{j l} \epsilon_{j},\]</div>
<p>Let us define <span class="math notranslate nohighlight">\({\cal R}\)</span> as a total rate, such that
<span class="math notranslate nohighlight">\({\cal R}_{l j}  = R_{l j} + C_{l j}\)</span>.
If we now impose statistical equilibrium</p>
<div class="math notranslate nohighlight">
\[({\cal R}_{l j}-{\cal R}_{j l})+({\cal R}_{u j}-{\cal R}_{ju})=0 \;\;\;,\]</div>
<p>we obtain</p>
<div class="math notranslate nohighlight">
\[\begin{split}\dot{E}_{j}^{R}+\dot{E}_{j}^{C}+{\cal R}_{ju}\epsilon_{j}+ {\cal R}_{j \ell}\epsilon_{l}  \nonumber \\  = \dot{A}_{j}^{R}+\dot{A}_{j}^{C}+{\cal R}_{u j} \epsilon_{j} +{\cal R}_{l j} \epsilon_{l}.\end{split}\]</div>
<p>This equation is the starting point for the macro-atom scheme. It shows that, when assuming radiative equilibrium, the energy flows through a system depend only on the transition probabilities and atomic physics associated with the levels the energy flow interacts with. By quantising this energy flow into radiant (<span class="math notranslate nohighlight">\(r-\)</span>) and kinetic (<span class="math notranslate nohighlight">\(k-\)</span>) packets, we can simulate the energy transport through a plasma discretised into volume elements (macro-atoms),whose associated transition probabilities govern the interaction of radiant and kinetic energy with the ionization and excitation energy associated with the ions of the plasma.</p>
<p>Although the equation above assumes strict radiative equilbrium,it is trivial to adjust it to include non-radiative source and sink terms. For example, in an expanding parcel of plasma, adiabatic cooling may be included with a simple modification to the RHS. Currently, we include adiabatic cooling by destroying packets with a probability
<span class="math notranslate nohighlight">\(p_{i,\mathrm{destruct}} = {\cal C}_{\rm adiabatic} / {\cal C}_{\rm tot}\)</span>.</p>
<section id="a-hybrid-scheme">
<h2>A Hybrid Scheme<a class="headerlink" href="#a-hybrid-scheme" title="Permalink to this heading"></a></h2>
<p>A pure macro-atom approach with only H and He can be easily used for some situations – for example, in the YSO application described by, which uses a H-only model. However, in accretion disc winds, the densities can be very high, and higher <span class="math notranslate nohighlight">\(Z\)</span> elements must be  included. Including all these elements as macro-atoms is not currently computationally feasible in the code for anything but the simplest models. We thus often use a <cite>hybrid scheme</cite>, which treats H and He with the macro-atom approach, but models all other atoms as <cite>simple-atoms</cite>.</p>
<p>Simple-atoms still interact with <span class="math notranslate nohighlight">\(r\)</span>- and <span class="math notranslate nohighlight">\(k\)</span>-packets but do not possess internal transition probabilities. As a result, they are analogous to the two-level atom treatment, as any excitation is immediately followed by a deactivation into an <span class="math notranslate nohighlight">\(r\)</span>- or <span class="math notranslate nohighlight">\(k\)</span>-packet. The choice of radiative or kinetic deactivation is made according to the relative rates in the two-level atom formalism. For a bound-bound transition <span class="math notranslate nohighlight">\(u\to j\)</span>, these two probabilities</p>
<p>are then</p>
<div class="math notranslate nohighlight">
\[p_{uj}^{S,R} = \frac{ A_{uj} \beta_{uj} } { A_{uj} \beta_{uj} + C_{uj} \exp(-h\nu_{uj} / k T_e) } = 1 - q\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[p_{uj}^{S,C} = \frac{ C_{uj} \exp(-h\nu_{uj} / k T_e) } { A_{uj} \beta_{uj} + C_{uj} \exp(-h\nu_{uj} / k T_e) } = q.\]</div>
<p>For a bound-free transition, the code assumes radiative recombination, and thus any bound-free simple-atom activation is immediately followed by the creation of an <span class="math notranslate nohighlight">\(r\)</span>-packet. This approximates the bound-free continuunm, even when compared to other two-level atom radiative transfer schemes. This is discussed further and tested in section~ref{sec:line_test}.</p>
<p>This hybrid approach preserves the fast treatment of, for example, UV resonance lines, while accurately modelling the recombination cascades that populate the levels responsible for, e.g., H and He line emission. As a result of this hybrid scheme, a separate set of estimators must be recorded for simple-atoms,  and the ionization and excitation of these elements is calculated with a different, approximate approach. In order to include simple-atoms, we must add in a few extra pathways, so that energy packets can also activate simple-atoms, through either bound-free or bound-bound processes. The relative probabilities of these channels are set in proportion with the simple-atom opacities.</p>
</section>
<section id="macro-atom-emissivity-calculation">
<h2>Macro-atom Emissivity Calculation<a class="headerlink" href="#macro-atom-emissivity-calculation" title="Permalink to this heading"></a></h2>
<p>In order to preserve the philosophy that a detailed spectrum is calculated in a limited wavelength regime, Python carries out a macro-atom emissivity calculation before the spectral cycles. The aim of this step is to calculate the luminosity contributed by macro-atoms – equivalent to the total amount of reprocessed emission – in the wavelength range being considered.</p>
<p>This process can be very computationally intensive, especially if the wavelength regime being simulated has very little emission from bound-free and line processes in the wind, but the overall broad-band emissivity is high. During the ionization cycles, the amount of energy absorbed into <span class="math notranslate nohighlight">\(k\)</span>-packets and every macro-atom level is recorded using MC estimators. Once  the ionization cycles are finished, and the model has converged, these absorption energies are split into a certain number of packets and tracked through the macro-atom machinery until a deactivation occurs. When this happens, the emissivity of the level the macro-atom de-activated from is incremented if the packet lies in the requested wavelength range. If it does not, then  the packet is thrown away. It is easy to see how what is essentially a MC rejection method can be an inefficient way of sampling this parameter space. Fortunately, this problem is parallelised in the code.</p>
<p>Once the emissivities have been calculated, the spectral synthesis can proceed. This is done in a different way to the ionization cycles. Photons are generated from the specified photon sources over the required wavelength range, but are now also generated according to the calculated macro-atom and <span class="math notranslate nohighlight">\(k\)</span>-packet emissivities in each cell. These photons are “extracted” as with normal photon packets. In order to ensure that radiative equilibrium still holds, any photon that interacts with a macro-atom or <span class="math notranslate nohighlight">\(k\)</span>-packet is immediately destroyed. The photons are tracked and extracted as normal until they escape the simulation; resonant scatters are dealt with by a combination of macro-atom photon production and destruction.</p>
<div class="admonition-developer-note-emissivities admonition">
<p class="admonition-title">Developer note: Emissivities</p>
<p>We are a little lax in terms of what we actually call an emissivity in the code. The quantities stored in variables like <code class="docutils literal notranslate"><span class="pre">kpkt_emiss</span></code> and <code class="docutils literal notranslate"><span class="pre">matom_emiss</span></code> in the plasma and macro-atom structures are actually <em>comoving-frame energies</em> in erg, which are sampled when generating <span class="math notranslate nohighlight">\(r\)</span>-packets in each cell. Roughly speaking, these are luminosities given that the code assumes a time unit of 1s. Similarly, when the code prints out level <em>emissivities</em> to screen and to the diag file, these are really a sum over all these quantities (and can approximately be thought of as level <em>luminosities</em>).</p>
</div>
</section>
<section id="bound-free-continua-of-simple-atoms">
<h2>Bound-free Continua of Simple Atoms<a class="headerlink" href="#bound-free-continua-of-simple-atoms" title="Permalink to this heading"></a></h2>
<div class="admonition-todo admonition" id="id3">
<p class="admonition-title">Todo</p>
<p>this section is not yet completely accurate.</p>
</div>
<p>Historically, when using the indivisible packet form of radiative transfer (<cite>macro_atoms_thermal_trapping</cite>, for example), the bound-free continua of simple atoms were treated in a simplified two-level framework. In this case, simple atoms are those <cite>without</cite> a full macro-atom model atom, usually the metals. In this two-level scheme, whenever a simple atom undergoes a bound-free interaction, it is excited into the continuum state, and this is immediately followed by recombination, and an <span class="math notranslate nohighlight">\(r\)</span>-packet or <span class="math notranslate nohighlight">\(k\)</span>-packet is created immediately. As a result, the scheme does not capture the physical situation whereby a recombination cascade can occur from an initial recombination to excited levels, leading to a gradual reddening of the photon if there are many interactions. This situation <strong>is</strong> modelled well by a full macro-atom treatment.</p>
<p>To try and slightly improve this scheme, we implemented a “total emissivity” upweighting scheme around 2018. The basic idea is that we pay attention to only the heating and cooling. In particular, the rates of all simple atom bound-free emission are governed by the <cite>emissivity</cite> of the bound-free process.</p>
<dl class="simple">
<dt>This result in two changes to the code for ionization cycles:</dt><dd><ul class="simple">
<li><p>whenever a k-packet is eliminated via a bound-free channel of a simple macro atom (simulating energy flow from the <span class="math notranslate nohighlight">\(k\)</span>-packet pool to the radiation pool, <span class="math notranslate nohighlight">\(k \to r\)</span>), we have that packet carry additional energy corresponding to the required ionization energy for that particular bf process. This means we upweight the energy of the packet by a factor <span class="math notranslate nohighlight">\(f_{\rm up} = \nu / (\nu - \nu_0)\)</span>, where <span class="math notranslate nohighlight">\(\nu\)</span> is the frequency of the new bound-free photon and <span class="math notranslate nohighlight">\(\nu_0\)</span> is the threshold frequency. This quantity is the ratio of the total energy carried by photons in the packet to the energy supplied to photons in the packet from the thermal pool.</p></li>
<li><p>whenever an r-packet is “absorbed” by a simple macro atom bound-free process we track explicitly only the flow of energy to the thermal pool. This means we force the creation of a <span class="math notranslate nohighlight">\(k\)</span>-packet, whereas before there woud be a choice, but we only take the contribution of the absorption to heating only: i.e. we downweight the packet energy by a factor <span class="math notranslate nohighlight">\(f_{\rm down} = (\nu - \nu_0) / \nu\)</span>.</p></li>
</ul>
</dd>
</dl>
<p>In the spectral cycles, interactions with simple bound-free continua now kill the photon, and <span class="math notranslate nohighlight">\(k \to r\)</span> follow the same behaviour as above, because in these cycles we introduce a precalculated band-limited <span class="math notranslate nohighlight">\(k\)</span>-packet emissivity.</p>
<p><strong>It is possible for some numerical problems to occur.</strong> For example, there is nothing to stop the value of <span class="math notranslate nohighlight">\(f_{\rm up}\)</span> being quite large, if the photon is being emitted close to the edge. This is most likely to happen when the electron temperature <span class="math notranslate nohighlight">\(T_e\)</span> is quite low, but there is nothing to stop it happening anywhere. This is most likely to lead to problems when the factor <span class="math notranslate nohighlight">\(f_{\rm up}\)</span> is comparable to the typical number of photon passages per cell, since then a single photon can dominate the heating or ionization estimators in a given cell and lead to convergence problems by dramatically exacerbating shot noise.</p>
<div class="admonition-deactivating-the-scheme admonition">
<p class="admonition-title">Deactivating the scheme</p>
<p>This mode can be used using the <a class="reference internal" href="../input/parameters/other/Diag/Diag.use_upweighting_of_simple_macro_atoms.html#diag-use-upweighting-of-simple-macro-atoms"><span class="std std-ref">Diag.use_upweighting_of_simple_macro_atoms</span></a>.
In this case the code will go back to using the two-level framework for simple atom bound free continua.</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="radiative_transfer.html" class="btn btn-neutral float-left" title="Radiative Transfer Modes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="relativity_comoving.html" class="btn btn-neutral float-right" title="Special Relativity and Co-Moving Frames" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2024, Knox Long, Christian Knigge, Stuart Sim, Nick Higginbottom, James Matthews, Sam Mangham, Edward Parkinson, Mandy Hewitt, Nicolas Scepi, Austen Wallis, Amin Mosallanezhad.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>