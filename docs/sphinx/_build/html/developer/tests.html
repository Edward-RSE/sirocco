<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unit Test Framework &mdash; python 86g documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Python Scripts" href="../py_progs.html" />
    <link rel="prev" title="Matrix Acceleration using CUDA" href="cuda.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            python
          </a>
              <div class="version">
                86
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quick.html"><em>Quick Guide to Python</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../running_python.html">Running Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input.html">Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../output.html">Outputs &amp; Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plotting.html">Plotting &amp; Processing Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation.html">Code Operation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../radiation.html">Radiation Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wind_models.html">Wind Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coordinate.html">Coordinate grids</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics.html">Physics &amp; Radiative Transfer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../atomic.html">Atomic Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../meta.html">Meta-documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../developer.html">Developer Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="programmer_notes.html">Programming Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="cuda.html">Matrix Acceleration using CUDA</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Unit Test Framework</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../py_progs.html">Python Scripts</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">python</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../developer.html">Developer Documentation</a></li>
      <li class="breadcrumb-item active">Unit Test Framework</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/developer/tests.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="unit-test-framework">
<h1>Unit Test Framework<a class="headerlink" href="#unit-test-framework" title="Permalink to this heading"></a></h1>
<p>Unit tests are an excellent way to ensure that any code you write is robust and correct. To manage unit testing, Python
uses the <a class="reference external" href="https://gitlab.com/cunity/cunit">CUnit</a> test framework. Unit tests are run by using <code class="code docutils literal notranslate"><span class="pre">make</span> <span class="pre">check</span></code> in
either the root directory of Python, or in the source/test directory.</p>
<section id="installing-cunit">
<h2>Installing CUnit<a class="headerlink" href="#installing-cunit" title="Permalink to this heading"></a></h2>
<p>Python has been tested to work with CUnit (and CUnity) versions newer than 2.1-3. A recent version of CUnit is provided
in the <code class="code docutils literal notranslate"><span class="pre">$PYTHON/software</span></code> directory and can be installed as a static library by using the Makefile in Python’s
root directory. To build CUnit from source, you will need <a class="reference external" href="https://cmake.org/">CMake</a> installed, which is a modern
build system for C and C++ projects.</p>
<p>CUnit will be installed (as a static library) at the same time as GSL and Python during the first-time install, e.g.,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="o">[</span><span class="nv">$PYTHON</span><span class="o">]</span><span class="w"> </span>./configure
$<span class="w"> </span><span class="o">[</span><span class="nv">$PYTHON</span><span class="o">]</span><span class="w"> </span>make<span class="w"> </span>install
</pre></div>
</div>
<p>It is also possible to install only CUnit, using the same Makefile, if Python and GSL are already installed on your
system,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="o">[</span><span class="nv">$PYTHON</span><span class="o">]</span><span class="w"> </span>make<span class="w"> </span>cunit
</pre></div>
</div>
<p>If compilation of CUnit fails, it’s more than likely that you could install a dynamic version of an older version of the
library from your system’s package manager, e.g.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># on macOS using homebrew</span>
$<span class="w"> </span>brew<span class="w"> </span>install<span class="w"> </span>cunit

<span class="c1"># on Debian based Linux distributions</span>
$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>libcunit1<span class="w"> </span>libcunit1-doc<span class="w"> </span>libcunit1-dev
</pre></div>
</div>
</section>
<section id="running-tests">
<h2>Running Tests<a class="headerlink" href="#running-tests" title="Permalink to this heading"></a></h2>
<p>To run the tests, navigate into one of three directories,</p>
<ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">$PYTHON</span></code></p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">$PYTHON/source</span></code></p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">$PYTHON/tests</span></code></p></li>
</ul>
<p>Then run the command <code class="code docutils literal notranslate"><span class="pre">make</span> <span class="pre">check</span></code> which will compile and run the unit tests,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="o">[</span><span class="nv">$PYTHON</span>/source<span class="o">]</span><span class="w"> </span>make<span class="w"> </span>check

CUnit<span class="w"> </span>-<span class="w"> </span>A<span class="w"> </span>unit<span class="w"> </span>testing<span class="w"> </span>framework<span class="w"> </span><span class="k">for</span><span class="w"> </span>C<span class="w"> </span>-<span class="w"> </span>Version<span class="w"> </span><span class="m">3</span>.2.7-cunity
<span class="w"> </span>http://cunit.sourceforge.net/

<span class="w"> </span>Suite:<span class="w"> </span>Compton<span class="w"> </span>Processes
<span class="w">   </span>Test:<span class="w"> </span>Klein-Nisina<span class="w"> </span>Formula<span class="w"> </span>...passed
<span class="w">   </span>Test:<span class="w"> </span>Compton<span class="w"> </span>Alpha<span class="w"> </span>-<span class="w"> </span>heating<span class="w"> </span>cross<span class="w"> </span>section<span class="w">  </span>...passed
<span class="w">   </span>Test:<span class="w"> </span>Compton<span class="w"> </span>Beta<span class="w"> </span>-<span class="w"> </span>cooling<span class="w"> </span>cross<span class="w"> </span>section<span class="w"> </span>...passed
<span class="w">   </span>Test:<span class="w"> </span>Compton<span class="w"> </span>Formula<span class="w"> </span>...passed
<span class="w"> </span>Suite:<span class="w"> </span>Matrix<span class="w"> </span>Functions:<span class="w"> </span>GNU<span class="w"> </span>Science<span class="w"> </span>Library
<span class="w">   </span>Test:<span class="w"> </span>Solve<span class="w"> </span>Matrix<span class="w"> </span>...passed
<span class="w">   </span>Test:<span class="w"> </span>Invert<span class="w"> </span>Matrix<span class="w"> </span>...passed

<span class="w"> </span>Run<span class="w"> </span>Summary<span class="w">       </span>-<span class="w">      </span>Run<span class="w">    </span>Failed<span class="w">  </span>Inactive<span class="w">   </span>Skipped
<span class="w">      </span>Suites<span class="w">       </span>:<span class="w">        </span><span class="m">2</span><span class="w">         </span><span class="m">0</span><span class="w">         </span><span class="m">0</span><span class="w">         </span><span class="m">0</span>
<span class="w">      </span>Asserts<span class="w">      </span>:<span class="w">       </span><span class="m">15</span><span class="w">         </span><span class="m">0</span><span class="w">       </span>n/a<span class="w">       </span>n/a
<span class="w">      </span>Tests<span class="w">        </span>:<span class="w">        </span><span class="m">6</span><span class="w">         </span><span class="m">0</span><span class="w">         </span><span class="m">0</span><span class="w">         </span><span class="m">0</span>

<span class="w"> </span>Elapsed<span class="w"> </span>Time:<span class="w"> </span><span class="m">0</span>.009<span class="o">(</span>s<span class="o">)</span>
</pre></div>
</div>
<p>The important output is the “Run Summary”, which lists the number of tests run and how many failed. To explain the
output a bit more, a suite is a collection of tests and a test is a function which evaluates the output of the function
being tested. If the output is deemed to be correct, the test passes. Otherwise, the function is counted as a failure.
The number of failed tests/suites is recorded in the “Failed” column of the table.</p>
<p>The asserts row in the table corresponds to the number of “checks” done, e.g. the number of function outputs checked for
correctness. In CUnit terminology, we assert that the output from a function should be something. If the output is that
something, then the test is a PASS otherwise it is marked as FAIL.</p>
<p>If a single test in a suite fails, the entire suite is marked as failed. In most cases, there are always more asserts
than suites and tests and there are always more, or an equal number of, tests than there are suites.</p>
</section>
<section id="writing-tests">
<h2>Writing Tests<a class="headerlink" href="#writing-tests" title="Permalink to this heading"></a></h2>
<section id="creating-a-new-test">
<h3>Creating a new test<a class="headerlink" href="#creating-a-new-test" title="Permalink to this heading"></a></h3>
<p>To create a test, we need to make a function which contains an assert statement from the CUnit library. An assert
statement is used to fail a test, so that if the condition in the assert statement is not true a failure is reported to
the CUnit test registry (more or that later). Test functions should not take any arguments and return an integer, which
is typically used to return an exit code which CUnit can use to determine is the test is successful or not it there are
no assert statements.</p>
<p>Assert statements come from the <code class="code docutils literal notranslate"><span class="pre">CUnit.h</span></code> header, with an exhaustive list of assertions available
<a class="reference external" href="https://cunit.sourceforge.net/doc/writing_tests.html">here</a>. The code example below is a modified exert from the
one of matrix unit tests. In the function, test data is retrieved and compared to the output from <code class="code docutils literal notranslate"><span class="pre">solve_matrix</span></code>
using an assert which compares two floating point arrays to within a tolerance.</p>
<p>It should be noted that this assertion is not part of the standard CUnit assertions. It is possible to make a new
assertion by writing a macro (or function) which implements the base <code class="code docutils literal notranslate"><span class="pre">CU_assertImplementation</span></code> assert
implementation. If you need to create your own assertion, these should be kept in <code class="code docutils literal notranslate"><span class="pre">$PYTHON/source/tests/assert.h</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text"><code class="code docutils literal notranslate"><span class="pre">$PYTHON/source/tests/tests/test_matrix.c</span></code></span><a class="headerlink" href="#id1" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;assert.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;CUnit/CUnit.h&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">test_solve_matrix</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">matrix_a</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">vector_b</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">vector_x</span><span class="p">;</span>

<span class="w">  </span><span class="cm">/* Get input data to `solve_matrix` and `vector_x` which is the &quot;correct&quot;</span>
<span class="cm">     answer we will use to compare to the output from `solve_matrix` */</span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">vector_size</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">get_err</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">get_solve_matrix_test_data</span><span class="p">(...,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">matrix_a</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vector_b</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vector_x</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vector_size</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">get_err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="cm">/* If we can&#39;t get the data, fail the test */</span>
<span class="w">    </span><span class="n">CU_FAIL</span><span class="p">(</span><span class="s">&quot;Unable to load test data&quot;</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Assertion from CUnit.h */</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/* Call `solve_matrix` with the input data from above */</span>

<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">test_vector_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">vector_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">matrix_err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">solve_matrix</span><span class="p">(</span><span class="n">matrix_a</span><span class="p">,</span><span class="w"> </span><span class="n">vector_b</span><span class="p">,</span><span class="w"> </span><span class="n">vector_size</span><span class="p">,</span><span class="w"> </span><span class="n">test_vector_x</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">matrix_err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="cm">/* If there is some numerical error (or otherwise) fail the test */</span>
<span class="w">    </span><span class="n">CU_FAIL</span><span class="p">(</span><span class="s">&quot;`solve_matrix` failed with error&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/* Use the following assertion to compare the value of the &quot;correct&quot; values (vector_x)</span>
<span class="cm">     against the output from `solve_matrix` (test_vector_x) */</span>

<span class="w">  </span><span class="n">CU_ASSERT_DOUBLE_ARRAY_EQUAL_FATAL</span><span class="p">(</span><span class="n">test_vector_x</span><span class="p">,</span><span class="w"> </span><span class="n">vector_x</span><span class="p">,</span><span class="w"> </span><span class="n">vector_size</span><span class="p">,</span><span class="w"> </span><span class="n">EPSILON</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Custom from assert.h */</span>

<span class="w">  </span><span class="n">free</span><span class="p">(</span><span class="n">matrix_a</span><span class="p">);</span>
<span class="w">  </span><span class="n">free</span><span class="p">(</span><span class="n">vector_b</span><span class="p">);</span>
<span class="w">  </span><span class="n">free</span><span class="p">(</span><span class="n">vector_x</span><span class="p">);</span>
<span class="w">  </span><span class="n">free</span><span class="p">(</span><span class="n">test_vector_x</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="admonition-including-code-python-h-in-your-tests admonition">
<p class="admonition-title">Including <code class="code docutils literal notranslate"><span class="pre">python.h</span></code> in your tests</p>
<p>If you need to access various structures or other things defined in <code class="code docutils literal notranslate"><span class="pre">python.h</span></code>, it is possible to include
the header file in your test source code as in the example below (there are some data structures which depend
on values defined in <code class="code docutils literal notranslate"><span class="pre">atomic.h</span></code>),</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;../../atomic.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;../../python.h&quot;</span>
</pre></div>
</div>
<p>In some situations this might complicate compilation of the unit test. In those cases, it could be better to
re-define anything you need in the source file for the unit test.</p>
</div>
</section>
<section id="creating-a-test-suite">
<h3>Creating a test suite<a class="headerlink" href="#creating-a-test-suite" title="Permalink to this heading"></a></h3>
<p>Unit tests belong in test suites and not by themselves. This means to create and run a unit test, we need a test suite
for that unit test to belong to. A test suite can be thought as a collection of tests, which are usually related. As an
example, there is a test suite for testing functions related to the Compton process and a test suite for matrix
functions.</p>
<p>The code exert below shows how to create a test suite and to add tests to the suite. The first step is to create a suite
to the CUnit test registry (the test registry is a global repository of test suites and associated tests) using
<code class="code docutils literal notranslate"><span class="pre">CU_add_suite</span></code>, which takes three arguments: the name of the suite, a function (pointer) to run when the suite
starts and a function to run after the suite has finished.</p>
<p>When a suite is added to the test registry, a pointer (<code class="code docutils literal notranslate"><span class="pre">CU_pSuite</span></code>) to the suite is returned from
<code class="code docutils literal notranslate"><span class="pre">CU_add_suite</span></code>. This pointer is used to add tests to the suite using <code class="code docutils literal notranslate"><span class="pre">CU_add_test</span></code> which takes three
arguments: a pointer to the suite to add the test to, the name of the test and the function (pointer) containing the
test. <code class="code docutils literal notranslate"><span class="pre">CU_add_test</span></code> returns a pointer to the test in the suite. If for whatever reason this fails, <code class="code docutils literal notranslate"><span class="pre">NULL</span></code> is
returned instead.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text"><code class="code docutils literal notranslate"><span class="pre">$PYTHON/source/tests/tests/test_matrix.c</span></code></span><a class="headerlink" href="#id2" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">create_matrix_test_suite</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* Create a test suite - if suite can&#39;t be made, return error code */</span>
<span class="w">    </span><span class="n">CU_pSuite</span><span class="w"> </span><span class="n">suite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CU_add_suite</span><span class="p">(</span><span class="n">suite_name</span><span class="p">,</span><span class="w"> </span><span class="n">matrix_suite_init</span><span class="p">,</span><span class="w"> </span><span class="n">matrix_suite_teardown</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">suite</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">CU_cleanup_registry</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">CU_get_error</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* Add some tests tests to suite - if one of them fails, return error code */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CU_add_test</span><span class="p">(</span><span class="n">suite</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Solve Matrix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">test_solve_matrix</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">CU_cleanup_registry</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">CU_get_error</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>The final two arguments for <code class="code docutils literal notranslate"><span class="pre">CU_add_suite</span></code> are used to initialise and clean up any additional data structures or
resources required to run the tests in the suite. In the matrix suite, for example, the cuSolver runtime is initialized
in <cite>matrix_suite_init</cite> and cleaned up in <cite>matrix_suite_teardown</cite>. An example of one of these functions, for the matrix
unit tests, is shown in the code exert below. These functions should not take any arguments and return an integer to
indicate if everything went OK or not.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text"><code class="code docutils literal notranslate"><span class="pre">$PYTHON/source/tests/tests/test_matrix.c</span></code></span><a class="headerlink" href="#id3" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">matrix_suite_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span>

<span class="cp">#ifdef CUDA_ON  </span><span class="cm">/* initialise cusolver */</span>
<span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cusolver_create</span><span class="p">();</span>
<span class="cp">#else  </span><span class="cm">/* for GSL, we want to disable the default error handler */</span>
<span class="w">    </span><span class="n">old_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsl_set_error_handler_off</span><span class="p">();</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>In the examples above, the code to create a suite and add tests is wrapped in a function
<code class="code docutils literal notranslate"><span class="pre">create_matrix_test_suite</span></code> with no arguments or return. All we need to do now to add those tests is to call that
function in the main function of the unit test framework, ensuring we do so after the test registry has been
initialized; this is done by the function  <code class="code docutils literal notranslate"><span class="pre">CU_initialize_registry</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text"><code class="code docutils literal notranslate"><span class="pre">$PYTHON/source/tests/unit_test_main.c</span></code></span><a class="headerlink" href="#id4" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* Create the test registry */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CU_initialize_registry</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">CU_SUCCESS</span><span class="p">)</span><span class="w">   </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">CU_get_error</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* Add any test suites to the registry */</span>
<span class="w">    </span><span class="n">create_matrix_test_suite</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/* Set how verbose logging should be - CU_BRM_VERBOSE gets you the</span>
<span class="cm">       output shown in the running tests section */</span>
<span class="w">    </span><span class="n">CU_basic_set_mode</span><span class="p">(</span><span class="n">CU_BRM_VERBOSE</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Run the test suites */</span>
<span class="w">    </span><span class="n">CU_basic_run_tests</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/* Check how many tests failed */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">num_tests_failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CU_get_number_of_tests_failed</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/* Report on the number of tests failed, or if everything passed */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">num_tests_failed</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\033</span><span class="s">[1;31m%d test(s) failed</span><span class="se">\n\033</span><span class="s">[1;0m&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">num_tests_failed</span><span class="p">);</span><span class="w">  </span><span class="cm">/* red text */</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\033</span><span class="s">[1;32mAll tests ran successfully</span><span class="se">\n\033</span><span class="s">[1;0m&quot;</span><span class="p">);</span><span class="w">  </span><span class="cm">/* green text */</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* Clean up the CUnit registry */</span>
<span class="w">    </span><span class="n">CU_cleanup_registry</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">num_tests_failed</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</section>
<section id="directory-and-structure">
<h3>Directory and structure<a class="headerlink" href="#directory-and-structure" title="Permalink to this heading"></a></h3>
<p>Unit tests should be kept in logically named files within the unit test directory located at
<code class="code docutils literal notranslate"><span class="pre">$PYTHON/source/tests/tests</span></code>. Any file in this directory should be added to the unit test Makefile, which is
located at <code class="code docutils literal notranslate"><span class="pre">$PYTHON/source/tests/Makefile</span></code>, specifically to the <code class="code docutils literal notranslate"><span class="pre">TEST_SOURCES</span></code> variable which is a list of
all the source code required specifically for the unit test framework; this includes both the unit tests themselves and
any other code required to, e.g., build and control the test registry. Prototypes for wrapper functions for creating
test suites (which are called in the main function) should be placed in <code class="code docutils literal notranslate"><span class="pre">$PYTHON/source/tests/tests/tests.h</span></code>
header file. Any data required for the tests should be kept in the data directory, <code class="code docutils literal notranslate"><span class="pre">$PYTHON/source/tests/data</span></code>, in
appropriately organised directories as shown below.</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text"><code class="code docutils literal notranslate"><span class="pre">$PYTHON/source/tests</span></code></span><a class="headerlink" href="#id5" title="Permalink to this code"></a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>tree<span class="w"> </span><span class="nv">$PYTHON</span>/source/tests

├──<span class="w"> </span>Makefile
├──<span class="w"> </span>assert.h
├──<span class="w"> </span>data
│<span class="w">   </span>└──<span class="w"> </span>matrix
│<span class="w">       </span>├──<span class="w"> </span>inverse_macro
│<span class="w">       </span>│<span class="w">   </span>├──<span class="w"> </span>inverse.txt
│<span class="w">       </span>│<span class="w">   </span>└──<span class="w"> </span>matrix.txt
│<span class="w">       </span>└──<span class="w"> </span>small_matrix
│<span class="w">           </span>├──<span class="w"> </span>A.txt
│<span class="w">           </span>├──<span class="w"> </span>b.txt
│<span class="w">           </span>└──<span class="w"> </span>x.txt
├──<span class="w"> </span>tests
│<span class="w">   </span>├──<span class="w"> </span>test_matrix.c
│<span class="w">   </span>└──<span class="w"> </span>tests.h
└──<span class="w"> </span>unit_test_main.c
</pre></div>
</div>
</div>
<p>We also need to include the Python source code we are testing in the <code class="code docutils literal notranslate"><span class="pre">PYTHON_SOURCES</span></code> variable of the Makefile. If
there are any CUDA files required, these should be added to the <code class="code docutils literal notranslate"><span class="pre">CUDA_SOURCES</span></code> variable. In theory, we should only
need to include the files containing the code we are testing. But in practise, we choose to instead include all of
Python’s source files (as it makes our lives easier) which increases compile time and the size of the final binary.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="cuda.html" class="btn btn-neutral float-left" title="Matrix Acceleration using CUDA" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../py_progs.html" class="btn btn-neutral float-right" title="Python Scripts" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2023, Knox Long, Christian Knigge, Stuart Sim, Nick Higginbottom, James Matthews, Sam Mangham, Edward Parkinson, Mandy Hewitt.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>